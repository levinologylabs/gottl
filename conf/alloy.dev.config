logging {
  level  = "info"
  format = "logfmt"
}

local.file_match "local_files" {
  path_targets = [{"__path__" = "/logs/*.log"}]
    sync_period = "5s"
}

loki.source.file "log_scrape" {
  targets    = local.file_match.local_files.targets
  forward_to = [loki.process.filter_logs.receiver]
  tail_from_end = true
}

loki.process "filter_logs" {
  stage.drop {
    source = ""
    expression  = ".*Connection closed by authenticating user root"
    drop_counter_reason = "noisy"
  }
  forward_to = [loki.write.grafana_loki.receiver]
}

loki.write "grafana_loki" {
  endpoint {
    url = "http://localhost:3100/loki/api/v1/push"

      // basic_auth {
      //  username = "admin"
      //  password = "admin"
      // }
  }
}




prometheus.exporter.unix "local_system" { }

prometheus.scrape "scrape_metrics" {
  targets         = prometheus.exporter.unix.local_system.targets
  forward_to      = [prometheus.relabel.filter_metrics.receiver]
  scrape_interval = "10s"
}
prometheus.relabel "filter_metrics" {
  rule {
    action        = "drop"
    source_labels = ["env"]
    regex         = "dev"
  }

  forward_to = [prometheus.remote_write.metrics_service.receiver]
}

prometheus.remote_write "metrics_service" {
    endpoint {
        url = "http://localhost:9090/api/v1/write"

        // basic_auth {
        //   username = "admin"
        //   password = "admin"
        // }
    }
}



//prometheus.remote_write "prod" {
//  endpoint {
//    url = "https://prod:9090/api/v1/write"
//  }
//}


// otelcol.exporter.otlp "default" {
//   client {
//     endpoint = "my-otlp-grpc-server:4317"
//     auth     = otelcol.auth.basic.credentials.handler
//   }
// }

// otelcol.auth.basic "credentials" {
//   // Retrieve credentials using environment variables.
// 
//   username = env("BASIC_AUTH_USER")
//   password = env("API_KEY")
// }

//otelcol.receiver.otlp "example" {
//  grpc {
//    endpoint = "127.0.0.1:4317"
//  }
//
//  http {
//    endpoint = "127.0.0.1:4318"
//  }
//
//  output {
//    metrics = [otelcol.exporter.otlp.default.input]
//    logs    = [otelcol.exporter.otlp.default.input]
//    traces  = [otelcol.exporter.otlp.default.input]
//  }
//}

